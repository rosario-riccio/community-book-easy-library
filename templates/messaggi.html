<!DOCTYPE html>
<!--Pagina per l'invio di messaggi-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>easyLibrary</title>
    <!-- Bootstrap -->
    <link href="{{url_for('static',filename='css/bootstrap.min.css')}}" rel="stylesheet">
    <link rel="stylesheet" href="{{url_for('static',filename='css/font-awesome.min.css')}}">
    <link rel="stylesheet" href="{{url_for('static',filename='css/myStyle.css')}}"/>
    <link rel="stylesheet" href="https://cdn.rawgit.com/konpa/devicon/df6431e323547add1b4cf45992913f15286456d3/devicon.min.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:800" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body style="background-color:#EEE">
    <div id="backgroundHeader" style="background-color:#5bc0de">
          <header>
            <nav class="navbar navbar-inverse navbar-fixed-top">
              <div class="container">
                <div class="navbar-header">
                  <button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#myNavBar">
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                  </button>
                  <a href="{{url_for('libreria')}}" class="navbar-brand"><i class="fa fa-book ff" aria-hidden="true"></i> EasyLibrary</a>
                </div>
                <div class="collapse navbar-collapse" id="myNavBar">
                  <ul class="nav navbar-nav">
                    <li><a class="nolink1" href="#">{{session['username']}}</span></a></li>
                    <li><a class="nolink1" href="#">BKcoin <span class="badge">{{session['bkcoin']}}</span></a></li>
                  </ul>
                  <!-- <form class="nav navbar-form navbar-left" id="searchForm" name="searchForm" action="javascript:" method="post" role="search">
                          <div class="input-group">
                                  <input id="textSearch" name="textSearch" type="search" class="form-control" placeholder="ricerca titolo..."/>
                                  <div class="input-group-btn">
                                      <button class="btn btn-default" type="submit"><i class="glyphicon glyphicon-search"></i></button>
                                  </div>
                          </div>
                  </form> -->


                  <ul class="nav navbar-nav navbar-right">
                      <li><a href="{{url_for('logout')}}"><i class="fa fa-sign-out" aria-hidden="true"></i> Logout</a></li>
                  </ul>
                  <ul class="nav navbar-nav navbar-right">
                      <li><a href="{{url_for('libreria')}}">Home</a></li>
                      <li><a href="{{url_for('ricerca')}}">Ricerca</a></li>
                      <li><a href="{{url_for('scaffale')}}">Scaffale</a></li>
                      <li class="active"><a href="{{url_for('messaggi')}}">Messaggi <span class="badge">{{session['messagesCount']}}</span></a></li>
                  </ul>
                </div>
              </div><!--container-->
            </nav>
          </header>
    </div>
    <section>
      <div id="myModal" class="modal fade" role="dialog">
        <div class="modal-dialog">
                <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4>Richiesta prenotazione</h4>
                        </div>
                        <div class="modal-body">
                            <form id="formModal" role="role" action="javascript:">
                                  <div class="form-group">
                                          <label class="control-label" for="usernameMessage1">Destinatario</label>
                                          <input type="text" class="form-control" id="usernameMessage1" name="usernameMessage1" disabled>
                                  </div>
                                  <div class="form-group">
                                          <label class="control-label" for="titleMessage1">Titolo</label>
                                          <input type="text" class="form-control" id="titleMessage1" name="titleMessage1" disabled>
                                  </div>
                                  <div class="form-group">
                                          <input type="hidden" class="form-control" id="idBook1" name="idBook1" disabled>
                                  </div>
                                  <div class="form-group">
                                          <label class="control-label" for="booking1">Scrivi un messaggio all'utente</label>
                                          <textarea row="3" class="form-control" id="message1" name="message1" required></textarea>
                                  </div>
                                  <div class="form-group">
                                        <button type="submit" class="btn btn-default">Invia</button>
                                  </div>
                              </form>
                        </div>
                </div>
        </div>
      </div>
      <div id="myModalSuccess" class="modal fade" role="dialog">
        <div class="modal-dialog">
                <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4>Richiesta prenotazione</h4>
                        </div>
                        <div class="modal-body">
                            <h5 style="font-weight:300;color:#AAA">Messaggio inviato con successo!</h5>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                </div>

        </div>
      </div>
      <div id="myModalSuccess1" class="modal fade" role="dialog">
        <div class="modal-dialog">
                <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                            <h4>Richiesta prenotazione</h4>
                        </div>
                        <div class="modal-body">
                            <h5 style="font-weight:300;color:#AAA">Prenotazione effettuata con successo</h5>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                        </div>
                </div>
        </div>
      </div>
      <div id="myModalFailure" class="modal fade" role="dialog">
      <div class="modal-dialog">
              <div class="modal-content">
                      <div class="modal-header">
                          <button type="button" class="close" data-dismiss="modal">&times;</button>
                          <h4>Richiesta prenotazione</h4>
                      </div>
                      <div class="modal-body">
                          <h5 style="font-weight:300;color:#AAA">Invio messaggio fallito!</h5>
                      </div>
                      <div class="modal-footer">
                          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                      </div>
              </div>
      </div>
    </div>
    <div id="myModalFailure1" class="modal fade" role="dialog">
    <div class="modal-dialog">
            <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4>Richiesta prenotazione</h4>
                    </div>
                    <div class="modal-body">
                        <h5 style="font-weight:300;color:#AAA">Prenotazione fallita!</h5>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
            </div>
    </div>
  </div>
    </section>
    <section>
        <div id="myMessages" style="margin-top:150px;min-height:400px;" class="container">
            <!--<div  data-idbook="idBook" data-title="title" data-username="fromUsername" class="row">
                  <div style="height:auto;background-color:#FFF" class="col-md-6 col-md-offset-3">
                             <h6 style="font-weight:300">fromUsername</h6>
                             <h6 style="font-weight:300">dateInsertMessages</h6>
                             <h6 style="font-weight:300">title</h6>
                             <hr>
                             <p>message</p>
                             <hr>
                             <div style="margin-bottom:10px;min-height:35px;">
                               <button type="button" class="bookingBT btn btn-info pull-right">Prenota <span class="glyphicon glyphicon-send"></span></button>
                                <button style="margin-right:5px;" type="button" class="bookingBT btn btn-default pull-right">Rispondi</span></button>
                             </div>
                   </div>
              </div> -->
       </div>
    </section>
    <section id="thirdContainer">
    </section>
    <footer>
      <div class="container" id="myFooter">
          <h3 style="font-weight:600">EASY LIBRARY<h3>
            <address style="font-size:15px;font-weight:300">
                Written by <a href="mailto:webmaster@example.com">Rosario Riccio</a>.<br>
                Visit us at:<br>
                Example.com<br>
              </address>
      </div>
    </footer>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="{{url_for('static',filename='js/jquery-3.2.1.min.js')}}"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="{{url_for('static',filename='js/bootstrap.min.js')}}"></script>
    <script>
    /*sendPosition consente l'invio della propria posizione mediante una richiesta AJAX*/
    function sendPosition(lat2,lon2){
            $.ajax({
              url:"{{url_for('sendPosition')}}",
              method:"POST",
              data:{"lat":lat2,"lon":lon2},
              dataType:"json",
              success:function(data){console.log(data.result)}
            });
        }
    /*updatePosition aggiorna la propria posizione*/
    function updatePosition(position){
            var lat2 = position.coords.latitude;
            var lon2 = position.coords.longitude;
            console.log("Update {{session['username']}}: "+lat2+" "+lon2);
            sendPosition(lat2,lon2);
        }
    /*initUpdatePosition sfruttera' la libreria API HTML 5 per la geolocalizzazione*/
    function initUpdatePosition(){
          navigator.geolocation.getCurrentPosition(updatePosition);
    }

    /*chiedera' al browser se sia possibile utilizzare la geolocalizzazione*/
    if(navigator.geolocation){
        initUpdatePosition();
        setInterval(initUpdatePosition,600000);
    }else{
        console.log("geolocalizzazione non abilitata");
    }
    </script>
    <script>
            //visualizzera' un modal (bootstrap widget) in base alla risposta del web server
            //alla richiesta ajax di prenotazione di un libro da parte del proprietario
            function resultResponse1(data){
              if(data[Object.keys(data)[0]]==false){
                $("#myModalFailure1").modal("show");
              }else{
                $("#myModalSuccess1").modal("show");
              }
            }
           //createBookingView consentira' la creazione dinamica dei messaggi
           function createMessageView(idBook,fromUsername,title,message,dateInsertMessages,messageTp){
           htmlContent='<div style="margin-bottom:20px;" data-idbook="'+idBook+'" data-title="'+title+'" data-username="'+fromUsername+'" class="row">'+
                             '<div style="height:auto;background-color:#FFF;padding:10px;" class="col-md-6 col-md-offset-3">';
                                  console.log("tipo "+messageTp);
                                  console.log(typeof messageTp);
                                  if(messageTp==true){
                                       htmlContent+='<h4 style="font-weight:300">Nuova richiesta di prenotazione</h4>'+
                                       '<hr>';
                                   }
                      htmlContent+='<h6 style="font-weight:300">utente: '+fromUsername+'</h6>'+
                                   '<h6 style="font-weight:300">Pubblicato il '+dateInsertMessages+'</h6>'+
                                   '<h6 style="font-weight:300">Titolo: '+title+'</h6>'+
                                   '<h6 style="font-weight:300">idBook: '+idBook+'</h6>'+
                                   '<hr>'+
                                   '<p>'+message+'</p>'+
                                   '<hr>'+
                                   '<div style="margin-bottom:10px;min-height:35px;">';
                                         if(messageTp==true){
                                              htmlContent+='<button type="button" class="bookingBT btn btn-info pull-right">Accetta <span class="glyphicon glyphicon-send"></span></button>';
                                          }
                                         htmlContent+='<button style="margin-right:5px;" type="button" class="responseBT btn btn-default pull-right">Rispondi</span></button>'+
                                   '</div>'+
                            '</div>'+
                      '</div>';
                    $("div#myMessages").append(htmlContent);
                    var message = $("div#myMessages").children().last();
                    var buttonResponse = message.find("button.responseBT");
                    var buttonBooking = message.find("button.bookingBT");
                    var nameClass = message.attr("class");
                    console.log(nameClass);
                    //aggiungera' un evento al bottone "Rispondi":
                    //sara' avviato il widget bootstrap modal per inviare un messaggio al proprietario/richiedente
                    //del libro
                    buttonResponse.click({message1:message},function(event,book){
                          var message2 = event.data.message1;
                          var idBook = message2.attr("data-idbook");
                          var title = message2.data("title");
                          var username = message2.data("username");
                          console.log("book selezionato = "+idBook);
                          $("#titleMessage1").val(title);
                          $("#usernameMessage1").val(username);
                          $("#idBook1").val(idBook);
                          $("#myModal").modal("show");
                    });
                    //aggiungera' un evento al bottone "Prenota": sara'
                    //avviata una richiesta AJAX per completare l'operazione di
                    //prenotazione da parte del proprietario del libro
                    buttonBooking.click({message1:message},function(event,book){
                          var message2 = event.data.message1;
                          var idBook = message2.attr("data-idbook");
                          var title = message2.data("title");
                          var username = message2.data("username");
                          $.ajax({
                            url:"{{url_for("acceptBooking")}}",
                            method:"POST",
                            dataType:"json",
                            data:{"idBook":idBook,"username":username,"title":title},
                            success:resultResponse1
                          });
                    });

           }
          //manageListMessages gestira' la risposta ad una richiesta AJAX effettuata dal metodo getMyMessages
          function manageListMessages(data){
              console.log(data);
              $("div#myMessages").empty();
              if(data.hasOwnProperty("result")){
                if(data["result"]==false){
                  htmlContent='<h3 class="text-center" style="color:#CCC;font-weight:300">Non ci sono prenotazioni!</h3>';
                  $("div#myMessages").append(htmlContent);
                  return 1;
                }
              }
              for (var key in data){
                  //console.log("key = "+key);
                  if(!data.hasOwnProperty(key)) continue;
                    var idBook = data[key].idBook;
                    var fromUsername = data[key].fromUsername;
                    var title = data[key].title;
                    var message = data[key].message;
                    var dateInsertMessage = data[key].dateInsertMessage;
                    var messageTp = data[key].messageTp;
                    console.log(idBook);
                    console.log(fromUsername);
                    //creera' un nuovo messaggio dinamicamente
                    createMessageView(idBook,fromUsername,title,message,dateInsertMessage,messageTp);
              }
          }
          //effettuera' la richiesta in AJAX per ottenere i propri messaggi
           function getMyMessages(){
                $.ajax({
                    url:"{{url_for("getListMessages")}}",
                    method:"POST",
                    dataType:"json",
                    success:manageListMessages
                });
           }

           //resultBooking attivera' uno specifico modal (boostrap ) in base all'esito dell'invio di un messaggio
            function resultResponse(data){
              if(data[Object.keys(data)[0]]==false){
                $("#myModalFailure").modal("show");
              }else{
                $("#myModalSuccess").modal("show");
              }
            }

            $(document).ready(function(){
              $("#formModal").submit(function(){
                  var username = $("#usernameMessage1").val();
                  var title = $("#titleMessage1").val();
                  var id = $("#idBook1").val();
                  var message1 = $("#message1").val();
                  console.log(message1);
                  var messageTp = false;
                  //richiesta di prenotazione da parte del proprietario
                  $.ajax({
                    url:"{{url_for("getBooking")}}",
                    method:"POST",
                    data:{"id":id,"username":username,"message1":message1,"title":title,"messageTp":messageTp},
                    dataType:"json",
                    success:resultResponse
                  });
                  $("#formModal")[0].reset();
                  $("#myModal").modal("hide");
                });
                getMyMessages();
            });
    </script>
  </body>
</html>
